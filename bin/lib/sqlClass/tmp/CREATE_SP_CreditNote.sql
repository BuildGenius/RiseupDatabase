CREATE PROCEDURE Incremental_push_CreditNote
AS
IF (EXISTS (
	SELECT * FROM INFORMATION_SCHEMA.TABLES
	WHERE TABLE_CATALOG = '[min-project]' 
	AND TABLE_SCHEMA = 'dbo' 
	AND TABLE_TYPE = 'BASE TABLE' 
	AND TABLE_NAME = 'CreditNote'
) ) 
BEGIN 
	INSERT INTO CreditNote (
		[RefKey],
	[TransactionID],
	[CNID],
	[CNBranch],
	[PaymentMethod],
	[CNDate],
	[CNNumber],
	[CusCode],
	[MemberName],
	[CurrencyCode],
	[ExchangeRate],
	[SellID],
	[SellBranch],
	[RefAllSellBill],
	[ApplySellID],
	[ApplyBranchID],
	[ApplyAmount],
	[TotalCNAmount],
	[CNAmountBV],
	[CNAmountAV],
	[VATType],
	[VATAmount],
	[CrTime],
	[UTime],
	[ImportTime],
	[BPC_status],
	[BPC_Remark],
	[BPC_StatusDatetime]
	) SELECT 
		[RefKey],
	[TransactionID],
	[CNID],
	[CNBranch],
	[PaymentMethod],
	[CNDate],
	[CNNumber],
	[CusCode],
	[MemberName],
	[CurrencyCode],
	[ExchangeRate],
	[SellID],
	[SellBranch],
	[RefAllSellBill],
	[ApplySellID],
	[ApplyBranchID],
	[ApplyAmount],
	[TotalCNAmount],
	[CNAmountBV],
	[CNAmountAV],
	[VATType],
	[VATAmount],
	[CrTime],
	[UTime],
	[ImportTime],
	[BPC_status],
	[BPC_Remark],
	[BPC_StatusDatetime]
	FROM [43.254.133.155].[ITECToAX].[dbo].CreditNote
	WHERE UTime > (SELECT MAX(UTime) FROM [dbo].CreditNote)
END
ELSE BEGIN 
	CREATE TABLE CreditNote (
		[RefKey] bigint,
	[TransactionID] int,
	[CNID] int,
	[CNBranch] int,
	[PaymentMethod] int,
	[CNDate] datetime,
	[CNNumber] varchar(30),
	[CusCode] varchar(20),
	[MemberName] varchar(300),
	[CurrencyCode] varchar(50),
	[ExchangeRate] money,
	[SellID] int,
	[SellBranch] int,
	[RefAllSellBill] varchar(MAX),
	[ApplySellID] int,
	[ApplyBranchID] int,
	[ApplyAmount] money,
	[TotalCNAmount] money,
	[CNAmountBV] money,
	[CNAmountAV] money,
	[VATType] int,
	[VATAmount] money,
	[CrTime] datetime,
	[UTime] datetime,
	[ImportTime] datetime,
	[BPC_status] int,
	[BPC_Remark] varchar(MAX),
	[BPC_StatusDatetime] datetime
	)
	
	INSERT INTO CreditNote (
		[RefKey],
	[TransactionID],
	[CNID],
	[CNBranch],
	[PaymentMethod],
	[CNDate],
	[CNNumber],
	[CusCode],
	[MemberName],
	[CurrencyCode],
	[ExchangeRate],
	[SellID],
	[SellBranch],
	[RefAllSellBill],
	[ApplySellID],
	[ApplyBranchID],
	[ApplyAmount],
	[TotalCNAmount],
	[CNAmountBV],
	[CNAmountAV],
	[VATType],
	[VATAmount],
	[CrTime],
	[UTime],
	[ImportTime],
	[BPC_status],
	[BPC_Remark],
	[BPC_StatusDatetime]
	) 
	SELECT 
        [RefKey],
	[TransactionID],
	[CNID],
	[CNBranch],
	[PaymentMethod],
	[CNDate],
	[CNNumber],
	[CusCode],
	[MemberName],
	[CurrencyCode],
	[ExchangeRate],
	[SellID],
	[SellBranch],
	[RefAllSellBill],
	[ApplySellID],
	[ApplyBranchID],
	[ApplyAmount],
	[TotalCNAmount],
	[CNAmountBV],
	[CNAmountAV],
	[VATType],
	[VATAmount],
	[CrTime],
	[UTime],
	[ImportTime],
	[BPC_status],
	[BPC_Remark],
	[BPC_StatusDatetime]
	FROM [43.254.133.155].[ITECToAX].[dbo].CreditNote
END